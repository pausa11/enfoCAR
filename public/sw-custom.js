// Custom Service Worker for Push Notifications
// This extends the service worker generated by next-pwa

// Import the next-pwa generated service worker
importScripts('/sw.js');

// Listen for push events
self.addEventListener('push', function (event) {
    console.log('[Service Worker] Push received:', event);

    let notificationData = {
        title: 'enfoCAR',
        body: 'Nueva notificaci√≥n',
        icon: '/icons/icon-192.png',
        badge: '/icons/icon-192.png',
        data: {},
    };

    if (event.data) {
        try {
            const data = event.data.json();
            notificationData = {
                title: data.title || notificationData.title,
                body: data.body || notificationData.body,
                icon: data.icon || notificationData.icon,
                badge: data.badge || notificationData.badge,
                tag: data.tag,
                requireInteraction: data.requireInteraction || false,
                actions: data.actions || [],
                data: data.data || {},
            };
        } catch (error) {
            console.error('[Service Worker] Error parsing push data:', error);
            notificationData.body = event.data.text();
        }
    }

    const promiseChain = self.registration.showNotification(
        notificationData.title,
        {
            body: notificationData.body,
            icon: notificationData.icon,
            badge: notificationData.badge,
            tag: notificationData.tag,
            requireInteraction: notificationData.requireInteraction,
            actions: notificationData.actions,
            data: notificationData.data,
        }
    );

    event.waitUntil(promiseChain);
});

// Listen for notification clicks
self.addEventListener('notificationclick', function (event) {
    console.log('[Service Worker] Notification clicked:', event);

    event.notification.close();

    // Get the URL to open from the notification data
    let urlToOpen = '/';

    if (event.notification.data && event.notification.data.url) {
        urlToOpen = event.notification.data.url;
    }

    // Handle action button clicks
    if (event.action) {
        console.log('[Service Worker] Action clicked:', event.action);

        if (event.notification.data && event.notification.data.actions) {
            const actionData = event.notification.data.actions[event.action];
            if (actionData && actionData.url) {
                urlToOpen = actionData.url;
            }
        }
    }

    // Open or focus the app window
    const promiseChain = clients.matchAll({
        type: 'window',
        includeUncontrolled: true
    }).then(function (windowClients) {
        // Check if there's already a window open
        for (let i = 0; i < windowClients.length; i++) {
            const client = windowClients[i];
            if (client.url === self.registration.scope + urlToOpen.substring(1) && 'focus' in client) {
                return client.focus();
            }
        }

        // If no window is open, open a new one
        if (clients.openWindow) {
            return clients.openWindow(urlToOpen);
        }
    });

    event.waitUntil(promiseChain);
});

// Listen for notification close events
self.addEventListener('notificationclose', function (event) {
    console.log('[Service Worker] Notification closed:', event);

    // You can track notification dismissals here if needed
    // For example, send analytics data
});

console.log('[Service Worker] Custom push notification service worker loaded');
